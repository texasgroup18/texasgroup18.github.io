<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Finance - Texas Group</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    /* Small page-specific tweaks (keeps same look as index) */
    .hero { text-align: center; padding: 36px 16px; background: #f5f7fb; }
    .hero h2 { margin: 0; font-size: 28px; }
    .hero p { margin: 6px 0 0; color: #666; }

    .container { max-width: 1200px; margin: 20px auto; padding: 0 16px; }

    .cards { display: flex; gap: 16px; flex-wrap: wrap; justify-content: center; margin-bottom: 18px; }
    .card { background: #fff; padding: 14px 18px; border-radius: 10px; box-shadow: 0 6px 18px rgba(0,0,0,0.06); min-width: 210px; text-align: center; }
    .card h3 { margin: 0; color: #1976d2; font-size: 14px; font-weight: 600; }
    .card p { margin: 8px 0 0; font-size: 18px; font-weight: 700; }

    .section-title { text-align: center; margin: 24px 0 8px; color: #333; font-size: 18px; }

    iframe.sheet { width: 100%; height: 420px; border: 1px solid #e6e6e6; border-radius: 8px; background: #fff; }

    footer { text-align: center; padding: 18px 0; background: #f8f8f8; color: #333; margin-top: 36px; }

    /* PASSWORD MODAL */
    #pwModal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.45);
      z-index: 9999;
    }
    #pwModal .card {
      width: 360px;
      max-width: 92%;
      text-align: center;
    }
    #pwModal input[type="password"] {
      width: calc(100% - 24px);
      padding: 10px;
      margin-top: 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    #pwModal button {
      margin-top: 12px;
      padding: 10px 18px;
      background: #1976d2;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }
    #pwModal .denied { color: #d32f2f; margin-top: 8px; display: none; font-weight: 600; }

    /* hide content before unlock (just in case) */
    .locked { visibility: hidden; }

    @media(max-width: 720px){
      .cards{flex-direction:column;align-items:center;}
      iframe.sheet{height:320px;}
    }
  </style>
</head>
<body>

  <!-- Header (same structure as index.html) -->
  <header>
    <div class="header-left">
      <img src="images/logo.JPG" alt="Texas Group Logo" class="logo" />
      <h1>Texas Group</h1>
    </div>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="about.html">About</a></li>
        <li><a href="services.html">Services</a></li>
        <li><a href="finance.html" style="text-decoration: underline;">Finance</a></li>
      </ul>
    </nav>
  </header>

  <!-- Hero -->
  <section class="hero">
    <h2>Finance Details</h2>
    <p>Together We Can</p>
  </section>

  <!-- Password modal (blocks view until correct password) -->
  <div id="pwModal" aria-hidden="false" role="dialog">
    <div class="card">
      <h3 style="margin-bottom:6px">Access Restricted</h3>
      <div style="color:#555">Enter password to view finance data</div>
      <input id="pwInput" type="password" placeholder="Enter password" />
      <div>
        <button id="pwSubmit" onclick="attemptUnlock()">Unlock</button>
      </div>
      <div class="denied" id="pwDenied">Access Denied ‚ùå ‚Äî wrong password</div>
      <p style="margin-top:10px;color:#777;font-size:13px">Contact admin for access</p>
    </div>
  </div>

  <!-- Main finance content (locked until password correct) -->
  <main id="mainContent" class="locked" aria-hidden="true">
    <div class="container">

      <!-- Summary cards -->
      <div class="cards" aria-live="polite">
        <div class="card">
          <h3>Total Collected</h3>
          <p id="totalCollected">‚Äî</p>
        </div>
        <div class="card">
          <h3>Total Fines</h3>
          <p id="totalFines">‚Äî</p>
        </div>
        <div class="card">
          <h3>Total Expenses</h3>
          <p id="totalExpenses">‚Äî</p>
        </div>
        <div class="card">
          <h3>Remaining Balance</h3>
          <p id="remainingAmount">‚Äî</p>
        </div>
      </div>

      <!-- Sections -->
      <div class="section-title">Contributions</div>
      <!-- data-src used so iframe does NOT load until unlock -->
      <iframe class="sheet" id="contribFrame"
        data-src="https://docs.google.com/spreadsheets/d/e/2PACX-1vS_rdpztfVyLrlPgSWmNIuGhLeo-g4n9Pw4Zdz0gz92pIXA9eaowq-d-g9GywvK8TlpZ1ET47i8czE8/pubhtml?gid=2096610384&single=true"
        title="Contributions sheet (published)">
      </iframe>

      <div class="section-title">Expenses</div>
      <iframe class="sheet" id="expenseFrame"
        data-src="https://docs.google.com/spreadsheets/d/e/2PACX-1vS_rdpztfVyLrlPgSWmNIuGhLeo-g4n9Pw4Zdz0gz92pIXA9eaowq-d-g9GywvK8TlpZ1ET47i8czE8/pubhtml?gid=715722052&single=true"
        title="Expenses sheet (published)">
      </iframe>

      <div class="section-title">Fines</div>
      <iframe class="sheet" id="finesFrame"
        data-src="https://docs.google.com/spreadsheets/d/e/2PACX-1vS_rdpztfVyLrlPgSWmNIuGhLeo-g4n9Pw4Zdz0gz92pIXA9eaowq-d-g9GywvK8TlpZ1ET47i8czE8/pubhtml?gid=0&single=true"
        title="Fines sheet (published)">
      </iframe>

      <div style="text-align:center; margin: 18px 0;">
        <a href="index.html" style="display:inline-block;padding:10px 16px;background:#1976d2;color:white;border-radius:8px;text-decoration:none;">‚¨Ö Back to Home</a>
      </div>

    </div>
  </main>

  <!-- Footer same as index -->
  <footer>
    <p>üìß Email: texasgroup18@gmail.com | üìû Contact: 8856967466</p>
    <p>&copy; 2025 Texas Group. All Rights Reserved.</p>
  </footer>

  <script>
    // PUBLIC CSV endpoints (published CSV exports - live)
    const CSV = {
      contributions: "https://docs.google.com/spreadsheets/d/e/2PACX-1vS_rdpztfVyLrlPgSWmNIuGhLeo-g4n9Pw4Zdz0gz92pIXA9eaowq-d-g9GywvK8TlpZ1ET47i8czE8/pub?gid=2096610384&single=true&output=csv",
      expenses:      "https://docs.google.com/spreadsheets/d/e/2PACX-1vS_rdpztfVyLrlPgSWmNIuGhLeo-g4n9Pw4Zdz0gz92pIXA9eaowq-d-g9GywvK8TlpZ1ET47i8czE8/pub?gid=715722052&single=true&output=csv",
      fines:         "https://docs.google.com/spreadsheets/d/e/2PACX-1vS_rdpztfVyLrlPgSWmNIuGhLeo-g4n9Pw4Zdz0gz92pIXA9eaowq-d-g9GywvK8TlpZ1ET47i8czE8/pub?gid=0&single=true&output=csv"
    };

    const PASSWORD = "Texas18";

    // Robust CSV parser (handles quoted fields)
    function parseCSV(text) {
      const rows = [];
      let row = [], field = "", inQuotes = false;
      for (let i=0; i<text.length; i++) {
        const ch = text[i], nxt = text[i+1];
        if (ch === '"') {
          if (inQuotes && nxt === '"') { field += '"'; i++; }
          else { inQuotes = !inQuotes; }
        } else if (ch === ',' && !inQuotes) {
          row.push(field); field = "";
        } else if ((ch === '\n' || ch === '\r') && !inQuotes) {
          if (field !== "" || row.length) { row.push(field); rows.push(row); row = []; field = ""; }
          // skip extra \r\n combos
        } else {
          field += ch;
        }
      }
      if (field !== "" || row.length) row.push(field), rows.push(row);
      return rows.filter(r => r.length); // drop empty rows
    }

    function parseNumberLoose(v) {
      if (v == null) return 0;
      if (typeof v === "number") return v;
      // remove non numeric except . and -
      const n = String(v).replace(/[^0-9.-]+/g,"");
      return n === "" ? 0 : Number(n);
    }

    // sums only the monthly contribution columns (detect header)
    function sumContributions(rows) {
      if (!rows || rows.length < 2) return 0;
      const header = rows[0].map(h => (h||"").trim());
      // find index of "Name" or fallback to 1
      let nameIdx = header.findIndex(h => /name/i.test(h));
      if (nameIdx === -1) nameIdx = 1;
      const monthStart = nameIdx + 1;
      let total = 0;
      for (let r = 1; r < rows.length; r++) {
        for (let c = monthStart; c < rows[r].length; c++) {
          total += parseNumberLoose(rows[r][c]);
        }
      }
      return total;
    }

    // sums a column by header label 'Amount' (case-insensitive) or fallback to last column
    function sumAmountColumn(rows) {
      if (!rows || rows.length < 2) return 0;
      const header = rows[0].map(h => (h||"").trim());
      let amountIdx = header.findIndex(h => /^amount$/i.test(h));
      if (amountIdx === -1) {
        // fallback: last column index
        amountIdx = header.length - 1;
      }
      let total = 0;
      for (let r = 1; r < rows.length; r++) {
        total += parseNumberLoose(rows[r][amountIdx]);
      }
      return total;
    }

    async function fetchCSVandParse(url) {
      const res = await fetch(url, {cache: "no-store"}); // no-store to get live updates
      const txt = await res.text();
      return parseCSV(txt);
    }

    async function computeAndRenderTotals() {
      try {
        const [contribRows, expenseRows, fineRows] = await Promise.all([
          fetchCSVandParse(CSV.contributions),
          fetchCSVandParse(CSV.expenses),
          fetchCSVandParse(CSV.fines)
        ]);

        const totalContrib = sumContributions(contribRows);
        const totalExpenses = sumAmountColumn(expenseRows);
        const totalFines = sumAmountColumn(fineRows);
        const remaining = totalContrib + totalFines - totalExpenses;

        const fmt = n => "‚Çπ " + Math.round(n).toLocaleString("en-IN");

        document.getElementById("totalCollected").textContent = fmt(totalContrib);
        document.getElementById("totalExpenses").textContent  = fmt(totalExpenses);
        document.getElementById("totalFines").textContent     = fmt(totalFines);
        document.getElementById("remainingAmount").textContent = fmt(remaining);
      } catch (err) {
        console.error("Totals fetch failed:", err);
        document.getElementById("totalCollected").textContent = "‚Äî";
        document.getElementById("totalExpenses").textContent  = "‚Äî";
        document.getElementById("totalFines").textContent     = "‚Äî";
        document.getElementById("remainingAmount").textContent = "‚Äî";
      }
    }

    // Unlock flow: set iframe src from data-src and compute totals
    function unlockUI() {
      // set iframe src to start loading sheets
      ["contribFrame","expenseFrame","finesFrame"].forEach(id=>{
        const el = document.getElementById(id);
        const src = el.getAttribute("data-src");
        if (src && !el.src) el.src = src;
      });

      // reveal main content
      document.getElementById("mainContent").classList.remove("locked");
      document.getElementById("mainContent").setAttribute("aria-hidden","false");
      // hide modal
      document.getElementById("pwModal").style.display = "none";

      // compute totals (live)
      computeAndRenderTotals();
    }

    // Called when user clicks Unlock
    function attemptUnlock() {
      const val = document.getElementById("pwInput").value;
      if (val === PASSWORD) {
        unlockUI();
      } else {
        const denied = document.getElementById("pwDenied");
        denied.style.display = "block";
        // small shake or quick feedback (optional)
      }
    }

    // Allow pressing Enter in password input
    document.addEventListener("keydown", function(e){
      const inputFocused = document.activeElement && document.activeElement.id === "pwInput";
      if (inputFocused && e.key === "Enter") attemptUnlock();
    });
  </script>
</body>
</html>